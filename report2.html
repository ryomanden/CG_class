<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>report2</title>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.137.4/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.137.4/examples/jsm/"
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/lil-gui@0.18"></script>
    <!-- Header -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.0.js"
            integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
    <script src="style.js"></script>
    <script type="text/javascript"> writeHeader("./"); </script>
    <!-- /header -->
</head>
<script type="module">
    /* --- IMPORT --- */
    import * as THREE from "three";
    import {GLTFLoader} from "three/addons/loaders/GLTFLoader.js";
    import {OrbitControls} from "three/addons/controls/OrbitControls.js";

    // lil-gui Params
    var GUI = lil.GUI;
    const params = {
        bg: {
            color: "#464646",
        },
        camera: {
            rotateSpeed: 1,
        },
        helper: {
            axisHelper: false,
            light1helper: false,
            light2helper: false,
        },
    };

    var init = function () {
        const gui = new GUI();

        // get screen size
        let width = window.innerWidth;
        let height = window.innerHeight;

        // create renderer
        var renderer = new THREE.WebGLRenderer({
            canvas: document.querySelector('#canvas'),
            antialias: true
        });
        renderer.setSize(width, height);
        renderer.setPixelRatio(window.devicePixelRatio); // Retina support

        // renderer Props
        renderer.physicallyCorrectLights = true;
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.shadowMap.enabled = true;

        document.body.appendChild(renderer.domElement);

        // create scene
        var scene = new THREE.Scene();
        scene.background = new THREE.Color("#464646");

        // create camera
        const camera = new THREE.PerspectiveCamera(45, width / height);
        const controls = new OrbitControls(camera, document.getElementById("canvas"));

        // camera Props
        camera.position.set(0, 5, 15); // initial position
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = params.camera.rotateSpeed;

        // shadow Props
        const shadowProps = function(light,size)  {
            light.shadow.camera.right = size;
            light.shadow.camera.left = -size;
            light.shadow.camera.top = -size;
            light.shadow.camera.bottom = size;
            light.shadow.mapSize.set(4096, 4096);
            light.castShadow = true;
        }

        /* --- OBJECT --- */

        // load car object
        const gltfLoader = new GLTFLoader();
        let mixer;
        let clock = new THREE.Clock();
        gltfLoader.load(
            './models/animatedCar.glb',
            function (gltf) {
                const model = gltf.scene;
                const animations = gltf.animations;
                model.traverse((obj) => {
                    if (obj.type === 'Mesh') {
                        // obj.receiveShadow = true;
                        obj.castShadow = true;
                    }
                    // else if (obj.type === 'PointLight') {
                    //     obj.castShadow = true;
                    //     const shadowSize = 20;
                    //     obj.shadow.camera.right = shadowSize;
                    //     obj.shadow.camera.left = -shadowSize;
                    //     obj.shadow.camera.top = -shadowSize;
                    //     obj.shadow.camera.bottom = shadowSize;
                    //
                    //     obj.shadow.mapSize.set(4096, 4096);
                    // }
                })
                scene.add(gltf.scene);

                // set animation mixer
                if (animations && animations.length) {
                    mixer = new THREE.AnimationMixer(model);
                    let animation = animations[1];
                    let action = mixer.clipAction(animation);
                    action.setLoop(THREE.LoopRepeat);
                    action.play()
                }
            }
        );

        // // create floor object
        // const floorGeometry = new THREE.BoxGeometry(3,0.2,7);
        // const floorMaterial = new THREE.MeshPhongMaterial({ color: 0x0f0f0f });
        // const floor = new THREE.Mesh(floorGeometry,floorMaterial);
        // floor.position.set(0,0,0);
        // floor.receiveShadow = true;
        // scene.add(floor);


        /* --- LIGHT --- */
        // ambient light
        const anvLight = new THREE.AmbientLight(0xffffff,3);
        scene.add(anvLight);

        // light1
        const Light1 = new THREE.PointLight(0xffffff,1);
        Light1.position.set(4, 4, 3);
        Light1.shadow.radius=10;
        shadowProps(Light1,20);
            // add scene
        scene.add(Light1);
        const Light1_helper = new THREE.PointLightHelper(Light1,1);
        Light1_helper.visible = params.helper.light1helper;
        scene.add(Light1_helper);
        // light2

        const Light2 = new THREE.PointLight(0xFF9C19,1);
        Light2.position.set(-5, 5, -5);
        Light2.shadow.radius=10;
        shadowProps(Light2,20);
        // add scene
        scene.add(Light2);
        const Light2_helper = new THREE.PointLightHelper(Light2,1);
        Light2_helper.visible = params.helper.light2helper;
        scene.add(Light2_helper);

        // helper
        const gridHelper = new THREE.GridHelper(2, 10); // size, step
        scene.add(gridHelper);
        const axisHelper = new THREE.AxisHelper(4);
        axisHelper.visible = params.helper.axisHelper;
        scene.add(axisHelper);

        /* --- USER INTERFACE --- */
        // background
        const bgUIGroup = gui.addFolder("Background");
        bgUIGroup.addColor(params.bg, 'color').onChange(v => scene.background.set(v));

        // camera
        const cameraUIGroup = gui.addFolder("Camera");
        cameraUIGroup.add(params.camera, 'rotateSpeed', 0, 10, 0.1).onChange(v => controls.autoRotateSpeed = v);

        // helper
        const helperUIGroup = gui.addFolder("Helper");
        helperUIGroup.add(params.helper, 'axisHelper').onChange(v => axisHelper.visible = v);
        helperUIGroup.add(params.helper, 'light1helper').onChange(v => Light1_helper.visible = v);
        helperUIGroup.add(params.helper, 'light2helper').onChange(v => Light2_helper.visible = v);

        // run every-frame
        update();
        function update  () {

            // camera auto rotate
            controls.update();

            // run animation mixer
            if(mixer){
                mixer.update(clock.getDelta());
            }

            // rendering
            requestAnimationFrame(update);
            renderer.render(scene, camera);
        };
    }
    window.addEventListener('DOMContentLoaded', init);
</script>
<style>
    body {
        margin: 0;
        padding: 0;
    }
</style>
<body>
<!-- Page title -->
<h1 class="absolute top-5 left-3 text-white text-xl">Report2</h1>
<!-- The button to open modal -->
<label for="my-modal-3" class="btn absolute bottom-5 right-5"><i class="fa-solid fa-pen-to-square pr-1"></i>
    Note</label>
<canvas id="canvas"></canvas>

<!-- Report modal -->
<input type="checkbox" id="my-modal-3" class="modal-toggle"/>
<div class="modal">
    <div class="modal-box relative">
        <label for="my-modal-3" class="btn btn-sm btn-circle absolute right-2 top-2"><i
                class="fa-solid fa-xmark"></i></label>
        <!-- Title -->
        <h3 class="text-lg font-bold">第2回　レポート</h3>
        <!-- Content -->
        <p class="py-4">
            ここに本文
        </p>
        <div class="py-4">
            <h4 class="bg-base-content text-base-100 font-medium rounded-full w-fit py-0.5 px-1 text-sm">参考</h4>
            <ul class="list-disc ml-6 mt-2">
                <!-- Citation -->
                <li><a class="link-accent"
                       href="https://ics.media/tutorial-three/object3d_group/">Three.jsで入れ子構造</a></li>
                <li><a class="link-accent"
                       href="https://steemit.com/utopian-io/@clayjohn/learning-3d-graphics-with-three-js-or-dynamic-geometry">Learning
                    3D Graphics With Three.js | Dynamic Geometry</a></li>
            </ul>
        </div>
    </div>
</div>
</body>
</html>